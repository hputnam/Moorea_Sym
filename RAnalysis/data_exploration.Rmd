---
title: "Moorea *Symbiodinium* data exploration"
author: "Ross Cunning"
date: "November 18, 2016"
output: html_document
---

```{r load}
library(phyloseq)
library(multcompView)
options(stringsAsFactors = FALSE)

taxcolors <- matrix(c("#8dd3c7", "#bebada", "#fb8072"), 
                    dimnames=list(c("CladeA", "CladeC", "CladeD")))

options(stringsAsFactors = FALSE)

load("Data/Moorea_sym100.RData")  # Load 100% OTUs phyloseq object
phy100.f <- phy.f  # Rename 100% OTUs as phy100.f
load("Data/Moorea_sym.RData")  # loads phyloseq object named phy.f
load("tempdata.RData") # loads the temperature data from temperature_analysis

library(seqinr)
library(phangorn) 
library(caroline)

# MOVE FILTERING TO MAKE FILE #
# Filter OTUs by minimum count
# Set threshold count
n <- 10
# Identify OTUs below threshold count
taxa <- taxa_sums(phy.f)[which(taxa_sums(phy.f) >= n)]
# Remove taxa below threshold count
phy.f <- prune_taxa(names(taxa), phy.f)
# Identify OTUs below threshold count
taxa <- taxa_sums(phy100.f)[which(taxa_sums(phy100.f) >= n)]
# Remove taxa below threshold count
phy100.f <- prune_taxa(names(taxa), phy100.f)


# Filter samples by minimum count
# Set threshold number of reads
sn <- 300
# Remove samples with fewer reads than threshold
phy.f <- prune_samples(sample_sums(phy.f)>=sn, phy.f)
# Remove samples with fewer reads than threshold
phy100.f <- prune_samples(sample_sums(phy100.f)>=sn, phy100.f)


# Filter OTUs by minimum count again in case any dropped below threshold after filtering samples
# Identify OTUs below threshold count
taxa <- taxa_sums(phy.f)[which(taxa_sums(phy.f) >= n)]
# Remove taxa below threshold count
phy.f <- prune_taxa(names(taxa), phy.f)
# Identify OTUs below threshold count
taxa <- taxa_sums(phy100.f)[which(taxa_sums(phy100.f) >= n)]
# Remove taxa below threshold count
phy100.f <- prune_taxa(names(taxa), phy100.f)


# Label clades and subtypes for filtered phyloseq object tax_tables
get.st <- function(df) {
  within(df, {
    Clade <- substr(hit, 1, 1)
    Subtype <- gsub(hit, pattern="_[A-Z]{2}[0-9]{6}", replacement="")
    Subtype <- gsub(Subtype, pattern="_multiple", replacement="")
    Subtype2 <- ifelse(as.numeric(sim)==100, paste0("'", Subtype, "'"),
                       paste0("'[", rep(rle(sort(Subtype))$values, times=rle(sort(Subtype))$lengths), "]'^", 
                              unlist(lapply(rle(sort(Subtype))$lengths, seq_len)))[order(order(Subtype))])
    #Subtype <- ifelse(as.numeric(sim)==100, Subtype, paste("*", Subtype, sep=""))
  })
}

tax_table(phy.f) <- as.matrix(get.st(data.frame(tax_table(phy.f), stringsAsFactors=FALSE)))
tax_table(phy100.f) <- as.matrix(get.st(data.frame(tax_table(phy100.f), stringsAsFactors=FALSE)))

# Convert to proportion (relative abundance)
phy.f.p <- transform_sample_counts(phy.f, function(x) x/sum(x))
# Apply transformation function
transform <- function(x) sqrt(x/sum(x))  # Set transformation function
phy.f.t <- transform_sample_counts(phy.f, transform)  # Transform data
# Convert to proportion (relative abundance)
phy100.f.p <- transform_sample_counts(phy100.f, function(x) x/sum(x))
# Apply transformation function
transform <- function(x) sqrt(x/sum(x))  # Set transformation function
phy100.f.t <- transform_sample_counts(phy100.f, transform)  # Transform data

plot_bar(phy.f.p, fill="Subtype", facet_grid=~Species)

write.table(data.frame(tax_table(phy.f)), "Data/tax.table.txt", row.names=T, quote=F)

```

# Unifrac Distance
```{r}
#https://rdrr.io/rforge/seqinr/man/dist.alignment.html
#returns sqrt of pairwise genetic distance, then squared the matrices
A.seqs <- read.alignment(file = "Data/A_tree_seqs_aligned_clean.fasta", format= "fasta")
A.dis <- (as.matrix(dist.alignment(A.seqs, matrix = "identity" )))^2
write.csv(A.dis, file="Data/A.dis.matx.csv")

C.seqs <- read.alignment(file = "Data/C_tree_seqs_aligned_clean.fasta", format= "fasta")
C.dis <- (as.matrix(dist.alignment(C.seqs, matrix = "identity" )))^2
write.csv(C.dis, file="Data/C.dis.matx.csv")

D.seqs <- read.alignment(file = "Data/D_tree_seqs_aligned_clean.fasta", format= "fasta")
D.dis <- (as.matrix(dist.alignment(D.seqs, matrix = "identity" )))^2
write.csv(D.dis, file="D.dis.matx.csv")

A_C <- matrix(0.1960, ncol=ncol(A.dis), nrow=nrow(C.dis), dimnames=list(rownames(C.dis), colnames(A.dis)))
A_D <- matrix(0.1775, ncol=ncol(A.dis), nrow=nrow(D.dis), dimnames=list(rownames(D.dis), colnames(A.dis)))
C_D <- matrix(0.1520, ncol=ncol(C.dis), nrow=nrow(D.dis), dimnames=list(rownames(D.dis), colnames(C.dis)))
  
#build ACD matrix
col1 <- rbind(A.dis, A_C, A_D)
col2 <- rbind(matrix(NA, nrow=nrow(A.dis), ncol=ncol(C.dis), dimnames=list(rownames(A.dis), colnames(C.dis))), C.dis, C_D)
col3 <- rbind(matrix(NA, nrow=nrow(A.dis)+nrow(C.dis), ncol=ncol(D.dis), dimnames=list(c(rownames(A.dis), rownames(C.dis)), colnames(D.dis))), D.dis)

ubermatrix <- cbind(col1, col2, col3)
dim(ubermatrix)

#build tree
uber.tree <- phangorn::upgma(ubermatrix)
plot(uber.tree, main="UPGMA")

# Slot uber tree into the phy_tree slot of the phyloseq object
phy_tree(phy.f) <- phy_tree(uber.tree)
phy_tree(phy.f.p) <- phy_tree(uber.tree)

# Calculate weighted Unifrac distance
UF.dis <- UniFrac(phy.f, weighted=TRUE, normalized=F, parallel=FALSE, fast=TRUE)

#NMDS on 97%-within-sample OTUs
ord <- ordinate(phy.f, "NMDS", UF.dis, trymax=100, trace=F)
plot_ordination(phy.f, ord, color="Species", shape="Site",
                title="97% within-sample OTUs")
```

# Clade overview
The relative abundance of each clade in the entire dataset (normalized for differences in sequencing depth across samples).
```{r clades}
cladeAbund <- aggregate(data.frame(RelAbund=rowSums(otu_table(phy.f.p))),
                        by=list(Clade=data.frame(tax_table(phy.f.p))$Clade), FUN=sum)
cladeAbund$Prop <- prop.table(cladeAbund$RelAbund)

bars <- barplot(cladeAbund$Prop*100, col=taxcolors, space=0,
                names.arg=cladeAbund$Clade, xlab=expression(paste(italic('Symbiodinium'), " Clade")),
                ylab="Relative abundance (%)")
text(bars, cladeAbund$Prop*100+2, labels=round(cladeAbund$Prop*100, 1), xpd=T)

cladeAbund$Notus <- table(data.frame(tax_table(phy.f.p))$Clade)
cladeAbund$Notus
```


# Clade compostion of each sample
In the first chart, bars are colored according to *Symbiodinium* clade. In the second chart, bars are colored according to OTU.
```{r cladecomp}
composition <- function(phy, col, legend=T) {
  samdat <- data.frame(sample_data(phy))
  #samdat$Genus <- factor(samdat$Genus, levels=rev(levels(samdat$Genus)))
  samdat$Species <- factor(samdat$Species, levels=rev(levels(samdat$Species)))
  samdat$Site <- factor(samdat$Site, levels=rev(levels(samdat$Site)))
  samdat <- samdat[with(samdat, order(Species, Site, -DNA.ID)), ]
  typerelabund <- as.matrix(otu_table(phy)[order(data.frame(tax_table(phy))$hit), 
                                           rownames(samdat)])
  sitebreaks <- c(as.character(samdat$Site), "X")==c("X", as.character(samdat$Site))
  sitebreaks <- which(sitebreaks==F) - 1
  spbreaks <- c(which(duplicated(samdat$Species)==F) - 1, nrow(samdat))
  
  # Make Barplot
  barplot(typerelabund, horiz=T, space=0, axes=F,axisnames=F, yaxs="i", col=col)
  rect(0, 0, par("usr")[2], par("usr")[4], lwd=1, xpd=T)
  axis(side=1, at=seq(0, 1, 0.1), line=0, tck=-0.025, mgp=c(0,0.25,0), cex.axis=0.7)
  mtext(side=1, "Relative abundance", cex=0.7, line=1)
  # Add legend
  if (legend==T) {
    legend(x=par("usr")[2]/2, y=par("usr")[4], xjust=0.5, yjust=0.25, horiz=T, bty="n", xpd=T, 
           cex=0.7, legend=c("A", "C", "D"), fill=taxcolors, x.intersp=0.5)
    legend(x=par("usr")[2]*1.1, y=par("usr")[4]*0.75, xjust=0, yjust=0.1, bty="n", xpd=T, cex=1, 
           pt.cex=1, legend=c("Site 1", "Site 2", "Site 3", "Site 7", "Site 8", "Site 9"), fill=c("purple", "blue", "green", "yellow", "orange", "red"), y.intersp=0.7, 
           x.intersp=0.3)
  }
  # Add grouping bars for Site
  sitecolors <- matrix(c("red", "orange", "yellow", "green", "blue", "purple"), 
              dimnames=list(c("Site 1", "Site 2", "Site 3", "Site 7", "Site 8", "Site 9"))) 
  for (i in 1:length(sitebreaks)) {
    lines(c(0, 1), c(sitebreaks[i], sitebreaks[i]), lty=2, lwd=0.25)
    rect(1.01, sitebreaks[i], 1.04, sitebreaks[i+1], col=sitecolors[samdat$Site[sitebreaks[i]+1],], 
         lwd=0.25, xpd=T)
  }
  
  # Add lines to separate species and species names
  for (i in 1:length(spbreaks)) {
    lines(c(0, 1.07), c(spbreaks[i], spbreaks[i]), xpd=T, type="l", lwd=0.4)
    text(1.03, (spbreaks[i] + spbreaks[i+1]) / 2, xpd=T, pos=4, cex=0.8,
         labels=paste(samdat$Genus[which(duplicated(samdat$Species)==F)][i], "\n",
                      samdat$Species[which(duplicated(samdat$Species)==F)][i], sep=""))
  }
  for (i in 1:nrow(samdat)) {
    text(0, i-0.5, rownames(samdat)[i], xpd=T, cex=0.7, pos=2)
  }
}

par(mfrow=c(1,1), mar=c(2, 1.5, 2, 10), lwd=0.1, cex=0.7, xpd=NA)
# Plot composition of 97% within-sample OTUs colored by clade
composition(phy.f.p, col=taxcolors[factor(data.frame(tax_table(phy.f.p))[order(data.frame(tax_table(phy.f.p))$Subtype), ]$Clade, levels=c("A","C","D"))], legend=T)


composition(phy.f.p, col=rainbow(ntaxa(phy.f.p)), legend=T)
```

```{r div}
#plot_richness(phy, x="Site", color = "Species")
```

# Analyze temperature distributions for each site
```{r tempdata}

# Plot temperature data
plot(temp.all$Date.Time, temp.all$Site.1, pch=15, col="darkred", cex=0.1, xlab="Time", ylab="Temperature Â°C",ylim=c(24,32))
points(temp.all$Date.Time, temp.all$Site.2, pch=15, col="red", cex=0.1)
points(temp.all$Date.Time, temp.all$Site.3, pch=15, col="pink", cex=0.1)
points(temp.all$Date.Time, temp.all$Site.7, pch=15, col="darkblue", cex=0.1)
points(temp.all$Date.Time, temp.all$Site.8, pch=15, col="blue", cex=0.1)
points(temp.all$Date.Time, temp.all$Site.9, pch=15, col="lightblue", cex=0.1)
#points(temp.all$Date.Time, temp.all$MCR1, pch=15, col="gray", cex=0.1)
#points(temp.all$Date.Time, temp.all$MCR6, pch=15, col="black", cex=0.1)

# Plot temperature distributions for each site
par(mfrow=c(2,3), mar=c(3,3,2,2), mgp=c(1.5,0.1,0), tcl=-0.2)
hist(temp.all$Site.1, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 1", xlab="Temp ?C")
hist(temp.all$Site.2, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 2", xlab="Temp ?C")
hist(temp.all$Site.3, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 3", xlab="Temp ?C")
hist(temp.all$Site.7, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 7", xlab="Temp ?C")
hist(temp.all$Site.8, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 8", xlab="Temp ?C")
hist(temp.all$Site.9, xlim=c(25,32), breaks=seq(25,32,0.25), main="Site 9", xlab="Temp ?C")
#hist(temp.all$MCR1, xlim=c(26.5,31.5), breaks=20, main="MCR1", xlab="Temp ?C")
#hist(temp.all$MCR6, xlim=c(26.5,31.5), breaks=20, main="MCR6", xlab="Temp ?C")

# View Descriptive Stats
temp.summ

# Plot rank order of various metrics
with(temp.summ, {
  par(mar=c(3,3,3,11), mfrow=c(1,1),xpd=TRUE)
  plot(NA, xaxt="n", xlim=c(1,6), ylim=c(1,6), xlab="", ylab="Rank Order")
  axis(side=1, at=1:6, labels = rownames(temp.summ))
  lines(rank(mean), type="b", pch=15, col="gray")
  lines(rank(var), type="b", pch=5, col="green")
  lines(rank(skew), type="b", pch=2, col="blue")
  # lines(rank(kurt), type="b", pch=4, col="purple")
  # lines(rank(hflat), type="b", pch=6, col="black")
  lines(rank(dip), type="b", pch=7, col="pink")
  lines(rank(daily.mean.min),type="b",pch=4, col="purple")
  lines(rank(daily.mean.max), type="b", pch=6, col="black")
  lines(rank(daily.mean.range), type="b",pch=5,col="orange")
  lines(rank(daysover30),type="b",pch=5,col="red")
  lines(rank(daysunder27.5),type="b",pch=5,col="darkblue")
  legend(6.5,7, legend=c("mean", "variance", "skewness", "bimodality", "mean daily min", "mean daily max", "mean daily range", "days over 30","days under 27.5"),
         lty=1, col=c("gray", "green", "blue", "pink", "purple", "orange","red","darkblue"),
         pch=c(15,5,2,7,4,6,5,5,5), inset=c(0,-0.4), xpd=NA)
})
```

```{r, echo=FALSE}
# PCA of various metrics
temp <- as.data.frame((temp.summ[,c(1:2,5:8,10,13)]))
pca.temp <- prcomp(temp, scale=TRUE) # Run PCA
summary(pca.temp)
par(mar=c(1,1,1,1))
plot(pca.temp)
biplot(pca.temp) #Plot PCA results on a biplot
aload <- abs(pca.temp$rotation)
sweep(aload, 2, colSums(aload), "/")

PCA1 <- data.frame(PCA1 = prcomp(temp, scale=TRUE)$x[,1]) # Extract the first principal component
PCA2 <- data.frame(PCA2 = prcomp(temp, scale=TRUE)$x[,2]) # Extract the second principal component
PCA3 <- data.frame(PCA3 = prcomp(temp, scale=TRUE)$x[,3]) # Extract the third principal component
PCA4 <- data.frame(PCA4 = prcomp(temp, scale=TRUE)$x[,4]) # Extract the fourth principal component
PCA <- cbind(PCA1,PCA2,PCA3)

# Append PCA1 as a new phy.f sample data column
sample_data(phy.f)$PCA1 <- sample_data(phy.f)$Site
sample_data(phy.f)$PCA1 <- gsub(" Site 1",PCA1[1,1],as.character(data.frame(sample_data(phy.f))$PCA1))
sample_data(phy.f)$PCA1 <- gsub(" Site 2",PCA1[2,1],as.character(data.frame(sample_data(phy.f))$PCA1))
sample_data(phy.f)$PCA1 <- gsub(" Site 3",PCA1[3,1],as.character(data.frame(sample_data(phy.f))$PCA1))
sample_data(phy.f)$PCA1 <- gsub(" Site 7",PCA1[4,1],as.character(data.frame(sample_data(phy.f))$PCA1))
sample_data(phy.f)$PCA1 <- gsub(" Site 8",PCA1[5,1],as.character(data.frame(sample_data(phy.f))$PCA1))
sample_data(phy.f)$PCA1 <- gsub(" Site 9",PCA1[6,1],as.character(data.frame(sample_data(phy.f))$PCA1))
# Append PCA2 as a new phy.f sample data column
sample_data(phy.f)$PCA2 <- sample_data(phy.f)$Site
sample_data(phy.f)$PCA2 <- gsub(" Site 1",PCA2[1,1],as.character(data.frame(sample_data(phy.f))$PCA2))
sample_data(phy.f)$PCA2 <- gsub(" Site 2",PCA2[2,1],as.character(data.frame(sample_data(phy.f))$PCA2))
sample_data(phy.f)$PCA2 <- gsub(" Site 3",PCA2[3,1],as.character(data.frame(sample_data(phy.f))$PCA2))
sample_data(phy.f)$PCA2 <- gsub(" Site 7",PCA2[4,1],as.character(data.frame(sample_data(phy.f))$PCA2))
sample_data(phy.f)$PCA2 <- gsub(" Site 8",PCA2[5,1],as.character(data.frame(sample_data(phy.f))$PCA2))
sample_data(phy.f)$PCA2 <- gsub(" Site 9",PCA2[6,1],as.character(data.frame(sample_data(phy.f))$PCA2))
# Append PCA3 as a new phy.f sample data column
sample_data(phy.f)$PCA3 <- sample_data(phy.f)$Site
sample_data(phy.f)$PCA3 <- gsub(" Site 1",PCA3[1,1],as.character(data.frame(sample_data(phy.f))$PCA3))
sample_data(phy.f)$PCA3 <- gsub(" Site 2",PCA3[2,1],as.character(data.frame(sample_data(phy.f))$PCA3))
sample_data(phy.f)$PCA3 <- gsub(" Site 3",PCA3[3,1],as.character(data.frame(sample_data(phy.f))$PCA3))
sample_data(phy.f)$PCA3 <- gsub(" Site 7",PCA3[4,1],as.character(data.frame(sample_data(phy.f))$PCA3))
sample_data(phy.f)$PCA3 <- gsub(" Site 8",PCA3[5,1],as.character(data.frame(sample_data(phy.f))$PCA3))
sample_data(phy.f)$PCA3 <- gsub(" Site 9",PCA3[6,1],as.character(data.frame(sample_data(phy.f))$PCA3))
# Append PCA4 as a new phy.f sample data column
# sample_data(phy.f)$PCA4 <- sample_data(phy.f)$Site
# sample_data(phy.f)$PCA4 <- gsub(" Site 1",PCA4[1,1],as.character(data.frame(sample_data(phy.f))$PCA4))
# sample_data(phy.f)$PCA4 <- gsub(" Site 2",PCA4[2,1],as.character(data.frame(sample_data(phy.f))$PCA4))
# sample_data(phy.f)$PCA4 <- gsub(" Site 3",PCA4[3,1],as.character(data.frame(sample_data(phy.f))$PCA4))
# sample_data(phy.f)$PCA4 <- gsub(" Site 7",PCA4[4,1],as.character(data.frame(sample_data(phy.f))$PCA4))
# sample_data(phy.f)$PCA4 <- gsub(" Site 8",PCA4[5,1],as.character(data.frame(sample_data(phy.f))$PCA4))
# sample_data(phy.f)$PCA4 <- gsub(" Site 9",PCA4[6,1],as.character(data.frame(sample_data(phy.f))$PCA4))

```

# Multivariate analyses
```{r, echo=FALSE, message=F}
library(vegan)
# Create a distance matrix from phy.f
vd <- vegdist(t(data.frame(otu_table(phy.f.p))),method="bray")
vd100 <- vegdist(t(data.frame(otu_table(phy100.f.p))),method="bray")

# Use phyloseq wrapper for capscale to conduct distance-based RDA
#phy.f.CAP <- ordinate(phy.f,method="CAP",distance="bray",formula=~PCA1)
#phy.f.CAP # Print ordination results
#p1 = plot_ordination(phy.f, phy.f.CAP, type="taxa", color="Clade", title="taxa")
#print(p1)
#p2 = plot_ordination(phy.f, phy.f.CAP, type="sample",color="Species")
#print(p2)

#NMDS on 97%-within-sample OTUs
ord <- ordinate(phy.f.t, "NMDS", distance = "bray", trymax=100, trace=F)
plot_ordination(phy.f.t, ord, color="Species", shape="Site",
                title="97% within-sample OTUs")

# plot_ordination(phy.f.t, ord, color="Site", shape="Species",
#                 title="97% within-sample OTUs")

#NMDS on 100% OTUs
ord <- ordinate(phy100.f.t, "NMDS", distance = "bray", trymax=100, trace=F)
plot_ordination(phy100.f.t, ord, color="Species", shape="Site",
                title="100% OTUs")

# plot_ordination(phy100.f.t, ord, color="Site", shape="Species",
#                 title="100% OTUs")


#phy.f.por <- subset_samples(phy.f,Species=="Porties")
#ord2 <- ordinate(phy.f.por, "NMDS", distance = "bray", trymax=100)
#plot_ordination(phy.f.por, ord2)

#phy.f.por.no.3 <- subset_samples(phy.f,DNA.ID!="209122")
#phy.f.por.no.3 <- subset_samples(phy.f.por.no.3,DNA.ID!="209100")
#phy.f.por.no.3 <- subset_samples(phy.f.por.no.3,DNA.ID!="209111")
#ord100 <- ordinate(phy.f.por.no.3,"PCoA", distance="bray",trymax=100)
#plot_ordination(phy.f.por.no.3,ord100,color="Species")

#phy.f.acr <- subset_samples(phy.f,Species=="Acropora")
#ord3 <- ordinate(phy.f.acr, "NMDS", distance = "bray", trymax=100)
#plot_ordination(phy.f.acr, ord3)

```

```{r,include=TRUE,echo=FALSE}
principal.coral <- subset_taxa(phy.f.p, taxa_sums(phy.f.p) > 0.01, prune=TRUE)
background.coral <- subset_taxa(phy.f.p, taxa_sums(phy.f.p) < 0.01, prune=TRUE)

```

# Evenness
```{r}
# Calculate Shannon Index and Pielou's Evenness for each sample
H <- diversity(t(otu_table(phy.f.p)))  # Shannon Index
J <- H/log(specnumber(t(otu_table(phy.f.p))))  # Pielou's Evenness
adiv <- cbind(data.frame(H), data.frame(J), sample_data(phy.f))
# Test for differences in Shannon index across species and sites
shannon.aov <- aov(adiv$H ~ adiv$Species * adiv$Site)
summary(shannon.aov)  # Significant Species effect
# Test for differences in Pielou's evenness across species and sites
pielou.aov <- aov(adiv$J ~ adiv$Species * adiv$Site)
summary(pielou.aov)  # Pielou: significant Species effect

# Plot diversity and evenness for Acropora
par(mfrow=c(2,1))
with(subset(adiv, Species=="Acropora"), {
  boxplot(H ~ Site, ylim=c(0, 2), ylab="Pielou's Evenness",
        outline=F, border="black",
        main="Acropora Symbiodinium Diversity (Shannon)")
  boxplot(J ~ Site, ylim=c(0, 1), ylab="Pielou's Evenness",
        outline=F, border="black",
        main="Acropora Symbiodinium Evenness")
})

# Plot diversity and evenness for Porites
with(subset(adiv, Species=="Porties"), {
  boxplot(H ~ Site, ylim=c(0, 0.5), ylab="Shannon Index",
        outline=F, border="black",
        main="Porites Symbiodinium Diversity")
  boxplot(J ~ Site, ylim=c(0, 0.5), ylab="Pielou's Evenness",
        outline=F, border="black",
        main="Porites Symbiodinium Evenness")
})

```

# Do diversity and evenness correlate with temperature regimes across sites?
```{r}
porites.diversity <- with(subset(adiv, Species=="Porties"), aggregate(H, list(Site), FUN=mean, na.rm=T))
porites.evenness <- with(subset(adiv, Species=="Porties"), aggregate(J, list(Site), FUN=mean, na.rm=T))
acropora.diversity <- with(subset(adiv, Species=="Acropora"), aggregate(H, list(Site), FUN=mean, na.rm=T))
acropora.evenness <- with(subset(adiv, Species=="Acropora"), aggregate(J, list(Site), FUN=mean, na.rm=T))

par(mfrow=c(2,1))
plot(pca.temp$x[,1], porites.diversity$x, ylim=c(0,1), main="Diversity vs. Temp. PC1")
points(pca.temp$x[,1], acropora.diversity$x, col="red")
plot(pca.temp$x[,1], porites.evenness$x, ylim=c(0,0.6), main="Evenness vs. Temp. PC1")
points(pca.temp$x[,1], acropora.evenness$x, col="red")
#legend("topleft", legend=c("Acropora", "Porites"), col=c("red", "black"), pch=21)

par(mfrow=c(2,1))
plot(pca.temp$x[,2], porites.diversity$x, ylim=c(0,1), main="Diversity vs. Temp. PC2")
points(pca.temp$x[,2], acropora.diversity$x, col="red")
plot(pca.temp$x[,2], porites.evenness$x, ylim=c(0,0.6), main="Evenness vs. Temp. PC2")
points(pca.temp$x[,2], acropora.evenness$x, col="red")
#legend("topleft", legend=c("Acropora", "Porites"), col=c("red", "black"), pch=21)

par(mfrow=c(2,1))
plot(pca.temp$x[,3], porites.diversity$x, ylim=c(0,1), main="Diversity vs. Temp. PC3")
points(pca.temp$x[,3], acropora.diversity$x, col="red")
plot(pca.temp$x[,3], porites.evenness$x, ylim=c(0,0.6), main="Evenness vs. Temp. PC3")
points(pca.temp$x[,3], acropora.evenness$x, col="red")
#legend("topleft", legend=c("Acropora", "Porites"), col=c("red", "black"), pch=21)

```

##### Evenness does not appear to differ among sites for either species and shows no relationship with temperature regimes

### Does number of clades correspond to temperature regime?
```{r}
# Get and count clades present in each sample
sample_data(phy.f) <- within(sample_data(phy.f), {
  clades <- apply(data.frame(otu_table(phy.f), check.names=F), 2, function(x) {
    unique(data.frame(tax_table(phy.f))[names(which(x!=0)), "Clade"])
  })
  nclades <- sapply(clades, length)
})

# Plot number of clades across sites
with(subset(sample_data(phy.f), Species=="Porties"), plot(nclades ~ Site, main = "Number of clades in Porites"))
with(subset(sample_data(phy.f), Species=="Acropora"), plot(nclades ~ Site, main="Number of clades in Acropora"))
```

### Does abundance of clade D correspond to temperature regime?
```{r}
# Test if abundance of clade D correlates with temp regime
cladeAbund <- apply(otu_table(phy.f.p), 2, function(x) aggregate(x, by=list(Clade=data.frame(tax_table(phy.f.p))$Clade), FUN=sum)$x)
rownames(cladeAbund) <- c("A", "C", "D")

sample_data(phy.f.p) <- within(sample_data(phy.f.p), {
  A <- t(cladeAbund)[, "A"]
  C <- t(cladeAbund)[, "C"]
  D <- t(cladeAbund)[, "D"]
  PC1 <- sample_data(phy.f)$PCA1
  PC2 <- sample_data(phy.f)$PCA2
  PC3 <- sample_data(phy.f)$PCA3
})

with(subset(sample_data(phy.f.p), Species=="Porties"), {
  par(mfrow=c(1,3))
  plot(D ~ PC1)
  plot(D ~ PC2)
  plot(D ~ PC3)
})

cor(apply(data.frame(subset(sample_data(phy.f.p), Species=="Porties")[, c("D", "PC1", "PC2", "PC3")]), 2, as.numeric))
     
with(subset(sample_data(phy.f.p), Species=="Acropora"), {
  par(mfrow=c(1,3))
  plot(D ~ PC1)
  plot(D ~ PC2)
  plot(D ~ PC3)
})

cor(apply(data.frame(subset(sample_data(phy.f.p), Species=="Acropora")[, c("D", "PC1", "PC2", "PC3")]), 2, as.numeric))

```

### Does beta diversity correspond to temperature regime?
```{r}
devtools::source_url("https://raw.githubusercontent.com/jrcunning/STJ2012/master/R/functions.R")

acropora <- subset_samples(phy.f.p, Species=="Acropora")
acrobd <- betad(acropora, group="Site")

porites <- subset_samples(phy.f.p, Species=="Porties")
porbd <- betad(porites, group="Site")

par(mfrow=c(3,1))
plot(pca.temp$x[,1], porbd$sambdsumm$mean, ylim=c(0,0.7), main="Beta diversity vs. Temp. PC1")
points(pca.temp$x[,1], acrobd$sambdsumm$mean, col="red")
plot(pca.temp$x[,2], porbd$sambdsumm$mean, ylim=c(0,0.7), main="Beta diversity vs. Temp. PC2")
points(pca.temp$x[,2], acrobd$sambdsumm$mean, col="red")
plot(pca.temp$x[,3], porbd$sambdsumm$mean, ylim=c(0,0.7), main="Beta diversity vs. Temp. PC3")
points(pca.temp$x[,3], acrobd$sambdsumm$mean, col="red")

```

### Does phylogenetically informed beta diversity correspond to temperature regime?
```{r}

betadiv <- function(phy, group) {
  # Calculate distances to species centroids for each sample in principal coordinate space
  samdat <- data.frame(sample_data(phy))
  UFdist <- UniFrac(phy, weighted=TRUE, normalized=F, parallel=FALSE, fast=TRUE)
  sambd <- betadisper(d=UFdist, group=samdat[, group], 
                      type="centroid", bias.adjust=FALSE)
  # Calculate each species' mean distance to centroid and standard error
  sambdsumm <- aggregate(data.frame(mean=as.vector(sambd$distances)), by=list(group=sambd$group), FUN=mean)
  sambdsumm$se <- aggregate(as.vector(sambd$distances), by=list(group=sambd$group), 
                            FUN=function(x) sd(x)/sqrt(length(x)))$x
  # Determine order of decreasing mean dispersion
  sambdsumm.ord <- sambdsumm[order(sambdsumm$mean, decreasing=T), ]
  # Update betadisper object with species in decreasing order of mean dispersion
  sambd <- betadisper(d=UFdist, 
                      group=factor(samdat[, group], levels=as.character(sambdsumm.ord$group)), 
                      type="centroid", bias.adjust=FALSE)
  # Use permutations to perform pairwise comparisons of group mean dispersions
  sampt <- permutest(sambd, pairwise=T)
  saml <- multcompLetters(sampt$pairwise$permuted)
  # Return results as a list
  return(list(sambdsumm.ord=sambdsumm.ord, sambdsumm=sambdsumm, saml=saml))
}

acropora.bd <- subset_samples(phy.f.p, Species=="Acropora")
acrobdiv <- betadiv(acropora.bd, group="Site")

porites.bd <- subset_samples(phy.f.p, Species=="Porties")
porbdiv <- betadiv(porites.bd, group="Site")

par(mfrow=c(3,1))
plot(pca.temp$x[,1], porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Temp. PC1")
points(pca.temp$x[,1], acrobdiv$sambdsumm$mean, col="red")
plot(pca.temp$x[,2], porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Temp. PC2")
points(pca.temp$x[,2], acrobdiv$sambdsumm$mean, col="red")
plot(pca.temp$x[,3], porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Temp. PC3")
points(pca.temp$x[,3], acrobdiv$sambdsumm$mean, col="red")

par(mfrow=c(3,1))
plot(temp.summ$daysover30, porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Days over 30")
points(temp.summ$daysover30, acrobdiv$sambdsumm$mean, col="red")

plot(temp.summ$daily.mean.range, porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Day Mean Range")
points(temp.summ$daily.mean.range, acrobdiv$sambdsumm$mean, col="red")

plot(temp.summ$var, porbdiv$sambdsumm$mean, ylim=c(0,0.15), main="Phylogenetically Informed Beta diversity vs. Variance")
points(temp.summ$var, acrobdiv$sambdsumm$mean, col="red")



```

