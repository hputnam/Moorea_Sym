---
title: 'OTUs: 100% vs 97%-within-sample'
author: "Ross Cunning"
date: "3/13/2017"
output: html_document
---

```{r load}

# Function to calculate summary statistics from phyloseq object

phystats <- function(phy) {
  return(
    data.frame(
      'Total count in OTU table'=sum(otu_table(phy)),
      'Number of OTUs'=ntaxa(phy),
      'Range of OTU counts'=paste0(range(taxa_sums(phy)), collapse=" - "),
      'Number of singleton OTUs'=length(taxa_sums(phy)[taxa_sums(phy) <= 1]),
      'Number of samples'=nsamples(phy),
      'Range of reads per sample'=paste0(range(sample_sums(phy)), collapse=" - "),
      'Arithmetic mean (± SD) reads per sample'=paste(as.integer(mean(sample_sums(phy))), 
                                                     as.integer(sd(sample_sums(phy))), sep=" ± "),
      'Geometric mean (*/ GSD) reads per sample'=paste(as.integer(exp(mean(log(sample_sums(phy))))),
                                                    as.integer(exp(sd(log(sample_sums(phy))))), sep=" */ "),
      check.names=F)
  )
}

otubarplot <- function(phy, main) {
  samdat <- data.frame(sample_data(phy))
  typerelabund <- as.matrix(otu_table(phy)[order(data.frame(tax_table(phy))$Subtype), 
                                           rownames(samdat)])
  typerelabund <- typerelabund[, rownames(sample_data(phy)[with(sample_data(phy), order(Site, DNA.ID))])]
  # Get info for plotting OTU names and blast hits on top of barplot
  blasthits <- as.character(data.frame(tax_table(phy))[order(data.frame(tax_table(phy))$Subtype), "Subtype2"])
  blasthits <- parse(text=blasthits)
  names <- as.character(rownames(data.frame(tax_table(phy)))[order(data.frame(tax_table(phy))$Subtype)])
  samples <- colnames(typerelabund)
  sites <- data.frame(sample_data(phy))[samples, "Site"]
  divides <- apply(typerelabund, 2, cumsum)
  heights <- diff(divides)
  heights[heights < 0.04] <- NA
  # Plot barplot and OTU names and blast hits
  bars <- barplot(typerelabund, col=rainbow(ntaxa(phy)), las=1, space=0.1, xaxs="i",
                  xlab="", ylab="", xaxt="n")
  text(bars, -0.06, labels=samples, xpd=T)
  text(bars, -0.14, labels=substr(sites, 7, 7), xpd=T)
  text(bars[1]/4, c(-0.06, -0.10), labels=c("sample:", "site:"), xpd=T, pos=2)
  mtext(side=2, text = "Relative Abundance", line=2)
  for (i in 1:length(bars)) {
    text(x=rep(bars[i], length(heights[which(!is.na(heights[,i])),i])), 
         y=divides[which(!is.na(heights[,i])),i] + heights[which(!is.na(heights[,i])),i] / 2, 
         labels=blasthits[which(!is.na(heights[,i]))+1],
         cex=0.7, srt=90)
    #paste(names[which(!is.na(heights[,i]))+1],
  }
  mtext(side=3, main, xpd=T, adj=0, line=0.5, font=2)
}



library(phyloseq)

taxcolors <- matrix(c("#8dd3c7", "#bebada", "#fb8072"), 
                    dimnames=list(c("CladeA", "CladeC", "CladeD")))

options(stringsAsFactors = FALSE)

load("../Data/Moorea_sym.RData"); phy97.f <- phy.f  # loads phyloseq object of 97% OTUs, renames to phy97.f
load("../Data/Moorea_sym100.RData"); phy100.f <- phy.f  # loads phyloseq object of 97% OTUs, renames to phy100.f

# Filter OTUs by minimum count
# Set threshold count
n <- 10
# Identify OTUs below threshold count
taxa <- taxa_sums(phy97.f)[which(taxa_sums(phy97.f) >= n)]
# Remove taxa below threshold count
phy97.f <- prune_taxa(names(taxa), phy97.f)
# Identify OTUs below threshold count
taxa <- taxa_sums(phy100.f)[which(taxa_sums(phy100.f) >= n)]
# Remove taxa below threshold count
phy100.f <- prune_taxa(names(taxa), phy100.f)


# Filter samples by minimum count
# Set threshold number of reads
sn <- 100
# Remove samples with fewer reads than threshold
phy97.f <- prune_samples(sample_sums(phy97.f)>=sn, phy97.f)
# Remove samples with fewer reads than threshold
phy100.f <- prune_samples(sample_sums(phy100.f)>=sn, phy100.f)


# Filter OTUs by minimum count again in case any dropped below threshold after filtering samples
# Identify OTUs below threshold count
taxa <- taxa_sums(phy97.f)[which(taxa_sums(phy97.f) >= n)]
# Remove taxa below threshold count
phy97.f <- prune_taxa(names(taxa), phy97.f)
# Identify OTUs below threshold count
taxa <- taxa_sums(phy100.f)[which(taxa_sums(phy100.f) >= n)]
# Remove taxa below threshold count
phy100.f <- prune_taxa(names(taxa), phy100.f)


# Label clades and subtypes for filtered phyloseq object tax_tables
get.st <- function(df) {
  within(df, {
    Clade <- substr(hit, 1, 1)
    Subtype <- gsub(hit, pattern="_[A-Z]{2}[0-9]{6}", replacement="")
    Subtype <- gsub(Subtype, pattern="_multiple", replacement="")
    Subtype2 <- ifelse(as.numeric(sim)==100, paste0("'", Subtype, "'"),
                       paste0("'[", rep(rle(sort(Subtype))$values, times=rle(sort(Subtype))$lengths), "]'^", 
                              unlist(lapply(rle(sort(Subtype))$lengths, seq_len)))[order(order(Subtype))])
    #Subtype <- ifelse(as.numeric(sim)==100, Subtype, paste("*", Subtype, sep=""))
  })
}

tax_table(phy97.f) <- as.matrix(get.st(data.frame(tax_table(phy97.f), stringsAsFactors=FALSE)))
tax_table(phy100.f) <- as.matrix(get.st(data.frame(tax_table(phy100.f), stringsAsFactors=FALSE)))


# Convert to proportion (relative abundance)
phy97.f.p <- transform_sample_counts(phy97.f, function(x) x/sum(x))
# Apply transformation function
transform <- function(x) sqrt(x/sum(x))  # Set transformation function
phy97.f.t <- transform_sample_counts(phy97.f, transform)  # Transform data

# Convert to proportion (relative abundance)
phy100.f.p <- transform_sample_counts(phy100.f, function(x) x/sum(x))
# Apply transformation function
transform <- function(x) sqrt(x/sum(x))  # Set transformation function
phy100.f.t <- transform_sample_counts(phy100.f, transform)  # Transform data
```

#### Descriptive stats of Filtered datasets
```{r phy.f_histograms, fig.height=4, fig.width=8}
# Compute summary statistics
stats97.f <- data.frame(`97% OTUs`=t(phystats(phy97.f)), check.names=F)
stats100.f <- data.frame(`100% OTUs`=t(phystats(phy100.f)), check.names=F)

# Create and plot histograms
taxhist97 <- hist(log10(taxa_sums(phy97.f)), plot=F)
taxhist100 <- hist(log10(taxa_sums(phy100.f)), plot=F)
samhist97 <- hist(log10(sample_sums(phy97.f)), plot=F)
samhist100 <- hist(log10(sample_sums(phy100.f)), plot=F)

par(mfrow=c(2, 4), mar=c(3,3,1,1))
plot(taxhist97, col="black", main="97% OTU counts", xlim=c(0, 6), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. OTUs", cex.lab=0.75, cex.axis=0.75)
plot(taxhist100, col="black", main="100% OTU counts", xlim=c(0, 6), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. OTUs", cex.lab=0.75, cex.axis=0.75)
plot(samhist97, col="black", main="97% OTU reads per sample", xlim=c(0, 6), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. samples", cex.lab=0.75, cex.axis=0.75)
plot(samhist100, col="black", main="100% OTU reads per sample", xlim=c(0, 6), las=1, mgp=c(2,0.5,0),
     xlab="No. sequences (log10)", ylab="No. samples", cex.lab=0.75, cex.axis=0.75)

# Create stats table
knitr::kable(cbind(stats97.f, stats100.f))
```
# *Symbiodinium* in each coral
For each coral species, barplots are presented showing the relative abundance of OTUs obtained by 100% and 97%-within-sample clustering. OTUs comprising more than 4% of a sample are labeled with the unique OTU number and the *Symbiodinium* subtype and NCBI GenBank accession number of the closest BLAST hit for that OTU in the reference database. OTU numbers and barplot colors are NOT comparable across clustering methods.

## *Porites sp.*  
```{r por, fig.height=12, fig.width=12}
# Create subsetted phyloseq objects for Porites sp.
por97.f.p <- subset_samples(phy97.f.p, Species=="Porties")
por100.f.p <- subset_samples(phy100.f.p, Species=="Porties")
# Plot custom barplots for Porites sp.
par(mfrow=c(2,1), mar=c(4,4,2,2), mgp=c(0,0.5,0), lwd=0.1)
otubarplot(por97.f.p, main="97% OTUs")
otubarplot(por100.f.p, main="100% OTUs")
```

## *Acropora hyacinthus*  
```{r acr, fig.height=12, fig.width=12}
# Create subsetted phyloseq objects for Acropora hyacinthus
acr97.f.p <- subset_samples(phy97.f.p, Species=="Acropora")
acr100.f.p <- subset_samples(phy100.f.p, Species=="Acropora")
# Plot custom barplots for Acropora hyacinthus
par(mfrow=c(2,1), mar=c(4,4,2,2), mgp=c(0,0.5,0), lwd=0.1)
otubarplot(acr97.f.p, main="97% OTUs")
otubarplot(acr100.f.p, main="100% OTUs")
```


